package com.tpadsz.navigator;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;

import com.tpadsz.navigator.entity.Bottom;
import com.tpadsz.navigator.entity.Button;
import com.tpadsz.navigator.entity.CenterLeft;
import com.tpadsz.navigator.entity.CenterRight;
import com.tpadsz.navigator.entity.IPageArea;
import com.tpadsz.navigator.entity.Navigator;
import com.tpadsz.navigator.entity.Top;

public class NavigatorProvider {
	Node[] newsSub = null;
	Node[] shoppingSub = null;
	Node[] readingSub = null;
	Node[] bottomSub = null;
	Node[] nodes;
	Node[] topDefault;
	Node[] leftDefault;
	Node[] rightDefault;
	Node[] bottomDefault;
	Connection conn = null;
	Random rnd = new Random();

	IButtonSourceAdapter buttonClickSource;
	Long staticsTimeLimit;

	public NavigatorProvider() {
		Node n1 = new Node(1, 1, 0, "新闻", "#");
		Node n2 = new Node(2, 1, 0, "购物", "#");
		Node n3 = new Node(3, 1, 0, "阅读", "#");
		Node n4 = new Node(4, 1, 0, "出去玩", "#");
		Node n5 = new Node(5, 2, 1, "娱乐", "#");
		Node n6 = new Node(6, 2, 1, "社会", "#");
		Node n7 = new Node(7, 2, 1, "体育", "#");
		Node n8 = new Node(8, 2, 1, "数码科技", "#");
		Node n9 = new Node(9, 2, 1, "军事", "#");
		Node n10 = new Node(10, 2, 1, "汽车", "#");
		Node n11 = new Node(11, 2, 1, "财经", "#");
		Node n12 = new Node(12, 2, 2, "团购", "#");
		Node n13 = new Node(13, 2, 2, "淘宝", "#");
		Node n14 = new Node(14, 2, 2, "京东", "#");
		Node n15 = new Node(15, 2, 2, "凡客", "#");
		Node n16 = new Node(16, 2, 2, "天猫", "#");
		Node n17 = new Node(17, 2, 3, "小说", "#");
		Node n18 = new Node(18, 2, 3, "搞笑", "#");
		Node n19 = new Node(19, 2, 3, "漫画", "#");
		Node n20 = new Node(20, 2, 3, "糗事百科", "#");
		Node n21 = new Node(21, 2, 4, "天气", "#");
		Node n22 = new Node(22, 2, 4, "地图", "#");
		Node n23 = new Node(23, 2, 4, "火车时刻", "#");
		Node n24 = new Node(24, 2, 4, "公交", "#");
		Node n25 = new Node(25, 2, 0, "看电影", "#");
		Node n26 = new Node(26, 2, 0, "视频", "#");
		Node n27 = new Node(27, 2, 0, "音乐", "#");
		Node n28 = new Node(28, 2, 0, "游戏", "#");
		Node n29 = new Node(29, 2, 0, "美食", "#");
		Node n30 = new Node(30, 2, 0, "社区", "#");
		Node n31 = new Node(31, 2, 0, "微博", "#");
		Node n32 = new Node(32, 2, 0, "生活百科", "#");
		Node n33 = new Node(33, 2, 0, "星座", "#");
		Node n34 = new Node(34, 2, 0, "邮件", "#");
		Node n35 = new Node(35, 2, 0, "应用市场", "#");
		Node n36 = new Node(36, 2, 0, "More", "#");
		newsSub = new Node[] { n5, n6, n7, n8, n9, n10, n11 };
		shoppingSub = new Node[] { n12, n13, n14, n15, n16 };
		readingSub = new Node[] { n17, n18, n19, n20 };
		bottomSub = new Node[] { n21, n22, n23, n24, n25, n26, n27, n28, n29,
				n30, n31, n32, n33, n34, n35 };
		nodes = new Node[] { n1, n2, n3, n4, n5, n6, n7, n8, n9, n10, n11, n12,
				n13, n14, n15, n16, n17, n18, n19, n20, n21, n22, n23, n24,
				n25, n26, n27, n28, n29, n30, n31, n32, n33, n34, n35, n36 };
		topDefault = new Node[] { n1, n5, n7 };
		leftDefault = new Node[] { n2 };
		rightDefault = new Node[] { n3 };
		bottomDefault = new Node[] { n27, n28, n29, n30, n33, n35, n36 };

		// try {
		// Class.forName("org.hsqldb.jdbcDriver");
		// conn = DriverManager.getConnection("jdbc:hsqldb:mem:nav_db", "sa",
		// "");
		// Statement stmt = conn.createStatement();
		// stmt
		// .execute("create table click (ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,userid VARCHAR_IGNORECASE(20) NOT NULL,buttonId INTEGER NOT NULL,date BIGINT NOT NULL)");
		// } catch (SQLException e) {
		// // TODO Auto-generated catch block
		// e.printStackTrace();
		// } catch (ClassNotFoundException e) {
		// // TODO Auto-generated catch block
		// e.printStackTrace();
		// }
	}

	private void setPicture(IPageArea ret, Button btn, int position) {
		if (ret == null || btn == null || btn.getPictures() == null) {
			return;
		}
		String template = ret.getTemplate();
		if (ret instanceof Top) {
			if (template != null && template.equals("1")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("3x2"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("2")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x2"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("3")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x2"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 4:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("4")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x2"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 4:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 5:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				default:
					break;
				}
			}
		} else if (ret instanceof CenterLeft || ret instanceof CenterRight) {
			if (template != null && template.equals("1")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x2"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("2")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("3")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				default:
					break;
				}
			} else if (template != null && template.equals("4")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 4:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 5:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				default:
					break;
				}
			}
		} else if (ret instanceof Bottom) {
			if (template != null && template.equals("1")) {
				switch (position) {
				case 1:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 2:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 3:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 4:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 5:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 6:
					btn.setPicture(btn.getPictures().get("1x1"));
					break;
				case 7:
					btn.setPicture(btn.getPictures().get("2x1"));
					break;
				default:
					break;
				}
			}
		}
	}

	private IPageArea getSuperAverageButtons(Map<Button, Integer> clicks,
			IPageArea ret) {
		ArrayList<Button> list = new ArrayList<Button>();
		Iterator<Button> it = clicks.keySet().iterator();
		ButtonClick[] bc = new ButtonClick[clicks.keySet().size()];
		int count = 0;
		int position = 1;
		while (it.hasNext()) {
			Button btn = it.next();
			bc[count++] = new ButtonClick(btn, clicks.get(btn));
		}
		Arrays.sort(bc);

		switch (clicks.keySet().size()) {
		case 0: {
			if (ret instanceof Top) {
				return getDefaultTop();
			} else if (ret instanceof CenterLeft) {
				return getDefaultCenterLeft();
			} else if (ret instanceof CenterRight) {
				return getDefaultCenterRight();
			} else if (ret instanceof Bottom) {
				return getDefaultBottom();
			}
		}
		case 1: {
			if (ret instanceof Top) {
				return getDefaultTop();
			} else if (ret instanceof CenterLeft) {
				return getDefaultCenterLeft();
			} else if (ret instanceof CenterRight) {
				return getDefaultCenterRight();
			} else if (ret instanceof Bottom) {
				return getDefaultBottom();
			}
		}
		case 2:
			// ret = new Top();
			if (bc[0].getClicks() + bc[1].getClicks() > 10) {
				ret.setTemplate("2");
			} else {
				ret.setTemplate("1");
			}
			// position = 1;
			// for (ButtonClick o : bc) {
			// setPicture(ret, o.getButton(), position++);
			// list.add(o.getButton());
			// }
			for (ButtonClick o : bc) {
				list.add(o.getButton());
			}
			ret.setButtons(list);

			break;
		case 3: {
			// ret = new Top();
			ret.setTemplate("3");
			// position = 1;
			// for (ButtonClick o : bc) {
			// setPicture(ret, o.getButton(), position++);
			// list.add(o.getButton());
			// }list.clear();
			for (ButtonClick o : bc) {
				list.add(o.getButton());
			}
			ret.setButtons(list);

		}
			break;
		case 4: {
			// ret = new Top();
			ret.setTemplate("4");
			position = 1;
			for (ButtonClick o : bc) {
				// setPicture(ret, o.getButton(), position++);
				list.add(o.getButton());
			}
			ret.setButtons(list);
		}
			break;

		default: {
			int sum = 0;
			for (ButtonClick o : bc) {
				sum += o.getClicks();
			}
			int avg = sum / bc.length;
			for (ButtonClick o : bc) {
				if (o.getClicks() < avg) {
					clicks.remove(o.getButton());
				}
			}
			// return getSuperAverageButtons(clicks, ret);
			ButtonClick[] newbc = new ButtonClick[clicks.keySet().size()];
			int c = 0;
			for (Button b : clicks.keySet()) {
				newbc[c++] = new ButtonClick(b, clicks.get(b));
			}
			Arrays.sort(newbc);
			list.clear();
			for (int i = 0; i < 4 && i < clicks.keySet().size(); i++) {
				// setPicture(ret, newbc[i].getButton(), i + 1);
				list.add(newbc[i].getButton());
			}
			if (ret instanceof Top) {
				switch (list.size()) {
				case 2:
					ret.setTemplate("1");
					break;
				case 3:
					ret.setTemplate("2");
					break;
				case 4:
					ret.setTemplate("3");
					break;
				default:
					return getRandomTop();
				}
			} else if (ret instanceof CenterRight || ret instanceof CenterLeft) {
				if (list.size() >= 1 && list.size() <= 4) {
					ret.setTemplate(Integer.toString(list.size()));
				} else {
					if (ret instanceof CenterLeft) {
						return getRandomCenterLeft();
					} else {
						return getRandomCenterRight();
					}
				}
			}
			ret.setButtons(list);
		}
		}
		return ret;
	}

	protected IPageArea getPreferredTop(String userId) {
		IPageArea ret = new Top();
		ret = getSuperAverageButtons(buttonClickSource.getAllNewsButtonClicks(
				userId, staticsTimeLimit), ret);

		ret.getButtons().add(0,
				buttonClickSource.getNewsButton(ret.getTemplate()));

		int position = 1;
		for (Button btn : ret.getButtons()) {
			setPicture(ret, btn, position++);
		}
		return ret;
	}

	protected IPageArea getPreferredLeft(String userId) {
		IPageArea ret = new CenterLeft();
		Map<Button, Integer> clicks = null;
		if (buttonClickSource.isShoppingHotterThanTraveling(userId)) {
			clicks = buttonClickSource.getAllShoppingButtonClicks(userId,
					staticsTimeLimit);
		} else {
			clicks = buttonClickSource.getAllTravelingButtonClicks(userId,
					staticsTimeLimit);
		}

		ret = getSuperAverageButtons(clicks, ret);
		ret
				.getButtons()
				.add(
						0,
						buttonClickSource.isShoppingHotterThanTraveling(userId) ? buttonClickSource
								.getShoppingButton(ret.getTemplate())
								: buttonClickSource.getTravelingButton(ret
										.getTemplate()));
		int position = 1;
		for (Button btn : ret.getButtons()) {
			setPicture(ret, btn, position++);
		}

		return ret;
	}

	protected IPageArea getPreferredRight(String userId) {
		IPageArea ret = new CenterRight();

		Map<Button, Integer> clicks = buttonClickSource
				.getAllReadingButtonClicks(userId, staticsTimeLimit);

		// System.err.println("-----------------" + ret.getClass().getName()
		// + "----------------------");
		// ret = getSuperAverageButtons(clicks, ret);
		// System.err.println("-----------------" + ret.getClass().getName()
		// + "----------------------");
		ret = getSuperAverageButtons(clicks, ret);
		ret.getButtons().add(0,
				buttonClickSource.getReadingButton(ret.getTemplate()));
		int position = 1;
		for (Button btn : ret.getButtons()) {
			setPicture(ret, btn, position++);
		}
		return ret;
	}

	protected Bottom getPreferredBottom(String userId) {
		Bottom ret = new Bottom();
		ret.setTemplate("1");
		Button first = buttonClickSource.isShoppingHotterThanTraveling(userId) ? buttonClickSource
				.getTravelingButton("1")
				: buttonClickSource.getShoppingButton("1");
		ArrayList<Button> list = new ArrayList<Button>(buttonClickSource
				.getBottom(userId, staticsTimeLimit));
		list.add(0, first);
		ret.setButtons(list);
		int position = 1;
		for (Button btn : ret.getButtons()) {
			setPicture(ret, btn, position++);
		}
		return ret;

	}

	protected Bottom getDefaultBottom() {
		Bottom ret = new Bottom();
		ret.setTemplate("1");
		ArrayList<Button> list = new ArrayList<Button>(5);
//		list.add(buttonClickSource.getTravelingButton("1"));
		list.addAll(buttonClickSource.getDefaultBottom());
		int count = 1;
		for (Button btn : list) {
			setPicture(ret, btn, count++);
		}
		return ret;
	}

	protected Bottom getRandomBottom() {
		Bottom ret = new Bottom();
		ret.setTemplate(Integer.toString(1));
		ArrayList<Button> buttons = new ArrayList<Button>(buttonClickSource
				.getRandomBottom());

		// for (int i = 0; i < 7 - 1; i++) {
		// Node node = bottomSub[rnd.nextInt(bottomSub.length)];
		// Button btn = new Button(node.getId(), "", 2, false, "1", "1,1", "",
		// node.getTitle(), "");
		// buttons.add(btn);
		// }
		Button last = new Button(3L,
				"http://pm.tpadsz.com:8080/UMS/nav/homemore", 1, false, "1",
				"1,1", "", "More", "");
		HashMap<String, String> pictures = new HashMap<String, String>();
		pictures.put("2x1", "image.action?inputPath=");
		last.setPictures(pictures);
		buttons.add(last);
		ret.setButtons(buttons);
		int position = 1;
		for (Button btn : ret.getButtons()) {
			setPicture(ret, btn, position++);
		}
		return ret;
	}

	protected CenterRight getDefaultCenterRight() {
		CenterRight ret = new CenterRight();
		ret.setTemplate("3");
		ArrayList<Button> list = new ArrayList<Button>(3);
//		list.add(buttonClickSource.getReadingButton("3"));
		list.addAll(buttonClickSource.getDefaultReading());

		int count = 1;
		for (Button btn : list) {
			setPicture(ret, btn, count++);
		}
		
		ret.setButtons(list);

		return ret;

	}

	protected CenterRight getRandomCenterRight() {
		CenterRight ret = new CenterRight();
		ArrayList<Button> list = new ArrayList<Button>(buttonClickSource
				.getRandom4Reading());
		int position = 1;
		for (Button btn : list) {
			setPicture(ret, btn, position++);
		}
		ret.setButtons(list);
		ret.setTemplate("4");
		return ret;
	}
	
	
	protected CenterLeft getDefaultCenterLeft(){
		CenterLeft ret=new CenterLeft();
		ret.setTemplate("1");
		ArrayList<Button> list=new ArrayList<Button>(buttonClickSource.getDefaultShopping());
//		list.add(buttonClickSource.getShoppingButton("1"));
//		setPicture(ret, list.get(0), 1);
		ret.setButtons(list);
		return ret;
	}

	protected CenterLeft getRandomCenterLeft() {
		CenterLeft ret = new CenterLeft();
		ArrayList<Button> list = null;
		if (buttonClickSource.isShoppingHotterThanTraveling(null)) {
			list = new ArrayList<Button>(buttonClickSource.getRandom4Shopping());
		} else {
			list = new ArrayList<Button>(buttonClickSource
					.getRandom4Traveling());
		}
		int position = 1;
		for (Button btn : list) {
			setPicture(ret, btn, position++);
		}
		ret.setButtons(list);
		ret.setTemplate("4");
		return ret;
	}
	
	protected Top getDefaultTop(){
		Top ret=new Top();
		ret.setTemplate("1");
		ArrayList<Button> list=new ArrayList<Button>(buttonClickSource.getDefaultNews());
//		list.add(0,buttonClickSource.getNewsButton("1"));
		int count=1;
		for(Button btn:list){
			setPicture(ret, btn, count++);
		}
		ret.setButtons(list);
		return ret;
	}

	protected IPageArea getRandomTop() {
		IPageArea ret = new Top();
		ArrayList<Button> list = new ArrayList<Button>(buttonClickSource
				.getRandom4News());

		int position = 1;
		for (Button btn : list) {
			setPicture(ret, btn, position++);
		}
		ret.setButtons(list);
		ret.setTemplate("4");

		return ret;
	}

	protected Navigator getNavigator(String userId) {

		Navigator nav = new Navigator();

		IPageArea top = getPreferredTop(userId);
		if (top == null) {
			top = getRandomTop();
		}
		IPageArea left = getPreferredLeft(userId);
		if (left == null) {
			left = getRandomCenterLeft();
		}
		IPageArea right = getPreferredRight(userId);
		if (right == null) {
			right = getRandomCenterRight();
		}
		Bottom bottom = getPreferredBottom(userId);
		if (bottom == null) {
			bottom = getRandomBottom();
		}

		nav.setTop((Top) top);
		nav.setBottom(bottom);
		nav.setLeft((CenterLeft) left);
		nav.setRight((CenterRight) right);

		return nav;
	}

	public Navigator getNavigator(Map<String, String> params) {
		Navigator ret = null;
		String imei = params != null ? params.get("imei") : null;
		String imsi = params != null ? params.get("imsi") : null;

		ret = getNavigator(imei != null ? imei : imsi);

		return ret;
	}

	public void logClick(Map<String, String> clientParams, Long buttonId) {
		// try {
		// PreparedStatement pst = conn
		// .prepareStatement("insert into click (userid, buttonId, date) values (?,?,?)");
		// String imei = clientParams.get("imei");
		// String imsi = clientParams.get("imsi");
		// pst.setString(1, imei);
		// pst.setInt(2, buttonId);
		// pst.setLong(3, System.currentTimeMillis());
		// pst.executeUpdate();
		// } catch (SQLException e) {
		// // TODO Auto-generated catch block
		// e.printStackTrace();
		// }
		buttonClickSource.logClick(clientParams, buttonId);
	}

	public IButtonSourceAdapter getButtonClickSource() {
		return buttonClickSource;
	}

	public void setButtonClickSource(IButtonSourceAdapter buttonClickSource) {
		this.buttonClickSource = buttonClickSource;
	}

	public Long getStaticsTimeLimit() {
		return staticsTimeLimit;
	}

	public void setStaticsTimeLimit(Long staticsTimeLimit) {
		this.staticsTimeLimit = staticsTimeLimit;
	}

}

class Node {
	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public Integer getClazz() {
		return clazz;
	}

	public void setClazz(Integer clazz) {
		this.clazz = clazz;
	}

	public Integer getParentId() {
		return parentId;
	}

	public void setParentId(Integer parentId) {
		this.parentId = parentId;
	}

	public String getTitle() {
		return title;
	}

	public void setTitle(String title) {
		this.title = title;
	}

	public String getLink() {
		return link;
	}

	public void setLink(String link) {
		this.link = link;
	}

	public Node(Integer id, Integer clazz, Integer parentId, String title,
			String link) {
		super();
		this.id = id;
		this.clazz = clazz;
		this.parentId = parentId;
		this.title = title;
		this.link = link;
	}

	Integer id;
	Integer clazz;
	Integer parentId;
	String title;
	String link;
}
